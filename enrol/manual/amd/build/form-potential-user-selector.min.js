define(["jquery","core/ajax","core/templates","core/str"],function(a,b,c,d){var e,f,g=100,h=500,i=!1,j=function(k,l,m,n){if(i||"undefined"==typeof e){if(i)return void(f=l)}else clearTimeout(e);var o=a(k).attr("courseid");"undefined"==typeof o&&(o="1");var p=a(k).attr("enrolid");"undefined"==typeof p&&(p=""),e=setTimeout(function(){i=!0;var e=b.call([{methodname:"core_enrol_get_potential_users",args:{courseid:o,enrolid:p,search:l,searchanywhere:!0,page:0,perpage:g+1}}]);e[0].then(function(b){var e=[],f=0;return b.length<=g?(a.each(b,function(b,d){var f=d,g=[];a.each(["idnumber","email","phone1","phone2","department","institution"],function(a,b){"undefined"!=typeof d[b]&&""!==d[b]&&(f.hasidentity=!0,g.push(d[b]))}),f.identity=g.join(", "),e.push(c.render("enrol_manual/form-user-selector-suggestion",f))}),a.when.apply(a.when,e).then(function(){var c=arguments;a.each(b,function(a,b){b._label=c[f],f++}),m(b)})):d.get_string("toomanyuserstoshow","core",">"+g).then(function(a){m(a)})}).fail(n).done(function(){i=!1,"undefined"!=typeof f&&(l=f,f=void 0,j(k,l,m,n))})},h)};return{processResults:function(b,c){var d=[];return a.isArray(c)?(a.each(c,function(a,b){d.push({value:b.id,label:b._label})}),d):c},transport:j}});